{% extends "base.html" %}

{% block title %}Assignment Summary - Teacher Portal{% endblock %}

{% block navbar %}
{% set active_nav = 'assignments' %}
{% include 'partials/teacher_navbar.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('teacher_assignments') }}">Assignments</a></li>
                    <li class="breadcrumb-item active">Summary Report</li>
                </ol>
            </nav>

            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h3><i class="bi bi-bar-chart me-2"></i>{{ assignment.title }}</h3>
                    <p class="text-muted mb-0">
                        <span class="badge bg-primary me-2">{{ assignment.subject }}</span>
                        {% if assignment.marking_type == 'rubric' or assignment.get('award_marks', True) %}
                        Total Marks: {{ assignment.total_marks }}
                        {% else %}
                        Grading: Correct / Partial correct / Incorrect
                        {% endif %}
                        {% if assignment.due_date %} | Due: {{ assignment.due_date }}{% endif %}
                    </p>
                </div>
                <div class="btn-group">
                    <a href="{{ url_for('manual_submission', assignment_id=assignment.assignment_id) }}" class="btn btn-outline-primary">
                        <i class="bi bi-file-earmark-plus me-1"></i>Manual submission
                    </a>
                    <a href="{{ url_for('feedback_summary_report', assignment_id=assignment.assignment_id) }}" class="btn btn-outline-primary">
                        <i class="bi bi-clipboard-data me-1"></i>Generate feedback & summary report
                    </a>
                    <a href="{{ url_for('download_assignment_report', assignment_id=assignment.assignment_id) }}" class="btn btn-primary">
                        <i class="bi bi-download me-1"></i>Download PDF Report
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h2 class="text-primary mb-0">{{ stats.submitted }}</h2>
                    <p class="text-muted mb-0">Submissions</p>
                    <small class="text-muted">of {{ stats.total_students }} students</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h2 class="text-success mb-0">{{ stats.reviewed }}</h2>
                    <p class="text-muted mb-0">Reviewed</p>
                    <small class="text-muted">{{ stats.pending }} pending</small>
                </div>
            </div>
        </div>
        {% if assignment.marking_type == 'rubric' or assignment.get('award_marks', True) %}
        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h2 class="{% if stats.avg_score >= 70 %}text-success{% elif stats.avg_score >= 50 %}text-warning{% else %}text-danger{% endif %} mb-0">
                        {{ "%.1f"|format(stats.avg_score) }}%
                    </h2>
                    <p class="text-muted mb-0">Average Score</p>
                    <small class="text-muted">{{ "%.1f"|format(stats.avg_marks) }}/{{ assignment.total_marks }}</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h2 class="text-info mb-0">{{ stats.pass_rate }}%</h2>
                    <p class="text-muted mb-0">Pass Rate</p>
                    <small class="text-muted">&ge;50% threshold</small>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h2 class="text-success mb-0">{{ stats.correct_count|default(0) }}</h2>
                    <p class="text-muted mb-0">Correct</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center h-100">
                <div class="card-body">
                    <h2 class="text-warning mb-0">{{ stats.partial_count|default(0) }}</h2>
                    <p class="text-muted mb-0">Partial / Incorrect</p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Item Analysis -->
    {% if item_analysis and not item_analysis.get('insufficient_data') and item_analysis.questions %}
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-clipboard2-data me-2"></i>Item Analysis</h5>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#item-analysis-legend">
                <i class="bi bi-question-circle me-1"></i>Legend
            </button>
        </div>
        <div class="collapse" id="item-analysis-legend">
            <div class="card-body border-bottom bg-light">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold">Facility Index (FI)</h6>
                        <p class="small text-muted mb-1">How easy the question is (mean marks / max marks)</p>
                        <span class="badge bg-success me-1">&ge;0.7 Easy</span>
                        <span class="badge bg-warning text-dark me-1">0.3-0.7 Moderate</span>
                        <span class="badge bg-danger">&lt;0.3 Hard</span>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold">Discrimination Index (DI)</h6>
                        <p class="small text-muted mb-1">How well it separates strong vs weak students (upper 27% - lower 27%)</p>
                        <span class="badge bg-success me-1">&ge;0.3 Good</span>
                        <span class="badge bg-warning text-dark me-1">0.1-0.3 Moderate</span>
                        <span class="badge bg-danger">&lt;0.1 Poor</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Question</th>
                            <th>FI</th>
                            <th>DI</th>
                            <th>Mean Score</th>
                            <th>Attempts</th>
                            <th>Interpretation</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for q in item_analysis.questions %}
                        <tr>
                            <td><strong>Q{{ q.q_num }}</strong></td>
                            <td>
                                {% if q.fi is not none %}
                                <span class="badge bg-{{ q.fi_color }}{% if q.fi_color == 'warning' %} text-dark{% endif %}">{{ q.fi }}</span>
                                <small class="text-muted ms-1">{{ q.fi_label }}</small>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if q.di is not none %}
                                <span class="badge bg-{{ q.di_color }}{% if q.di_color == 'warning' %} text-dark{% endif %}">{{ q.di }}</span>
                                <small class="text-muted ms-1">{{ q.di_label }}</small>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if q.mean_marks is not none %}
                                {{ q.mean_marks }}/{{ q.max_marks|int }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>{{ q.attempt_count }}</td>
                            <td><small>{{ q.interpretation }}</small></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% if item_analysis.student_count is defined %}
        <div class="card-footer text-muted small">
            Based on {{ item_analysis.student_count }} students. Upper/lower groups: {{ item_analysis.group_size }} students each (27%).
        </div>
        {% endif %}
    </div>
    {% elif item_analysis and item_analysis.get('insufficient_data') %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-clipboard2-data me-2"></i>Item Analysis</h5>
        </div>
        <div class="card-body text-center text-muted py-4">
            <i class="bi bi-info-circle" style="font-size: 2rem;"></i>
            <p class="mt-2 mb-0">Not enough graded submissions to compute item analysis. At least 2 submissions with per-question marks are needed.</p>
        </div>
    </div>
    {% endif %}

    <!-- AI Class Summary -->
    <div class="card mb-4" id="ai-summary-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI Class Summary</h5>
            <div>
                {% if ai_class_summary and not ai_class_summary.get('error') %}
                <small class="text-muted me-2" id="summary-timestamp">
                    {% if ai_class_summary.generated_at %}Generated: {{ ai_class_summary.generated_at[:16] }}{% endif %}
                </small>
                <button class="btn btn-sm btn-outline-primary" onclick="generateClassSummary()" id="regenerate-btn">
                    <i class="bi bi-arrow-clockwise me-1"></i>Regenerate
                </button>
                {% else %}
                <button class="btn btn-sm btn-primary" onclick="generateClassSummary()" id="generate-btn">
                    <i class="bi bi-stars me-1"></i>Generate Summary
                </button>
                {% endif %}
            </div>
        </div>
        <div class="card-body" id="ai-summary-content">
            {% if ai_class_summary and not ai_class_summary.get('error') %}
            <div class="row g-3">
                {% if ai_class_summary.concepts_grasped %}
                <div class="col-md-6">
                    <h6 class="text-success"><i class="bi bi-check-circle-fill me-1"></i>Concepts Grasped</h6>
                    <ul class="list-unstyled">
                        {% for c in ai_class_summary.concepts_grasped %}
                        <li class="mb-1"><i class="bi bi-check text-success me-1"></i>{{ c }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                {% if ai_class_summary.misconceptions %}
                <div class="col-md-6">
                    <h6 class="text-warning"><i class="bi bi-exclamation-triangle-fill me-1"></i>Misconceptions</h6>
                    <ul class="list-unstyled">
                        {% for m in ai_class_summary.misconceptions %}
                        <li class="mb-1"><i class="bi bi-exclamation-circle text-warning me-1"></i>{{ m }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                {% if ai_class_summary.areas_needing_clarification %}
                <div class="col-md-6">
                    <h6 class="text-danger"><i class="bi bi-flag-fill me-1"></i>Areas Needing Clarification</h6>
                    <ul class="list-unstyled">
                        {% for a in ai_class_summary.areas_needing_clarification %}
                        <li class="mb-1"><i class="bi bi-arrow-right text-danger me-1"></i>{{ a }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                {% if ai_class_summary.recommended_actions %}
                <div class="col-md-6">
                    <h6 class="text-primary"><i class="bi bi-list-check me-1"></i>Recommended Actions</h6>
                    <ol class="ps-3">
                        {% for r in ai_class_summary.recommended_actions %}
                        <li class="mb-1">{{ r }}</li>
                        {% endfor %}
                    </ol>
                </div>
                {% endif %}
            </div>
            {% if ai_class_summary.question_notes %}
            <hr>
            <h6><i class="bi bi-card-text me-1"></i>Per-Question Notes</h6>
            <div class="row g-2">
                {% for qn in ai_class_summary.question_notes %}
                <div class="col-md-6">
                    <div class="d-flex align-items-start">
                        <span class="badge bg-secondary me-2">Q{{ qn.q_num }}</span>
                        <small>{{ qn.note }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% elif ai_class_summary and ai_class_summary.get('error') %}
            <div class="text-center text-muted py-3">
                <i class="bi bi-exclamation-circle" style="font-size: 1.5rem;"></i>
                <p class="mt-2 mb-0">{{ ai_class_summary.error }}</p>
            </div>
            {% else %}
            <div class="text-center text-muted py-4" id="summary-placeholder">
                <i class="bi bi-robot" style="font-size: 2rem;"></i>
                <p class="mt-2 mb-0">Click "Generate Summary" to get AI-powered analysis of class performance, misconceptions, and recommended actions.</p>
            </div>
            {% endif %}
            <div class="text-center py-4 d-none" id="summary-loading">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 mb-0 text-muted">Analyzing class performance...</p>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Score Distribution & Insights -->
        <div class="col-lg-5 mb-4">
            <!-- Score Distribution (marks) or Result Distribution (Correct/Partial/Incorrect) -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>{% if assignment.marking_type == 'rubric' or assignment.get('award_marks', True) %}Score Distribution{% else %}Result Distribution{% endif %}</h5>
                </div>
                <div class="card-body">
                    {% if assignment.marking_type == 'rubric' or assignment.get('award_marks', True) %}
                    {% for grade, data in score_distribution.items() %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>{{ grade }}</span>
                            <span>{{ data.count }} students ({{ data.percentage }}%)</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar {{ data.color }}" style="width: {{ data.percentage }}%">
                                {{ data.count }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Correct</span>
                            <span>{{ stats.correct_count|default(0) }} students</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-success" style="width: {% if stats.submitted > 0 %}{{ (stats.correct_count|default(0) / stats.submitted * 100)|round }}{% else %}0{% endif %}%">{{ stats.correct_count|default(0) }}</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Partial correct</span>
                            <span>{{ stats.partial_count|default(0) }} students</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-warning" style="width: {% if stats.submitted > 0 %}{{ (stats.partial_count|default(0) / stats.submitted * 100)|round }}{% else %}0{% endif %}%">{{ stats.partial_count|default(0) }}</div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Areas of Strength & Improvement -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Class Insights</h5>
                </div>
                <div class="card-body">
                    {% if insights.recommendations %}
                    <div class="alert alert-info mb-4">
                        <h6 class="alert-heading"><i class="bi bi-clipboard-check me-1"></i>Teaching Recommendations</h6>
                        <ul class="mb-0">
                            {% for rec in insights.recommendations %}
                            <li>{{ rec }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if insights.strengths %}
                    <h6 class="text-success"><i class="bi bi-check-circle me-1"></i>Areas of Strength</h6>
                    <ul class="list-unstyled mb-4">
                        {% for item in insights.strengths %}
                        <li class="mb-2">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-success me-2">Q{{ item.question }}</span>
                                {{ item.correct }}/{{ item.total }} correct ({{ item.percentage }}%)
                            </div>
                            <div class="progress mt-1" style="height: 6px;">
                                <div class="progress-bar bg-success" style="width: {{ item.percentage }}%"></div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}

                    {% if insights.improvements %}
                    <h6 class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Areas to Address</h6>
                    <ul class="list-unstyled mb-4">
                        {% for item in insights.improvements %}
                        <li class="mb-3">
                            <div class="d-flex align-items-center">
                                <span class="badge bg-danger me-2">Q{{ item.question }}</span>
                                {{ item.incorrect }}/{{ item.total }} need improvement ({{ item.percentage }}%)
                            </div>
                            <div class="progress mt-1" style="height: 6px;">
                                <div class="progress-bar bg-danger" style="width: {{ item.percentage }}%"></div>
                            </div>
                            {% if item.common_wrong %}
                            <div class="mt-2 ps-3">
                                <small class="text-muted">Common wrong answers:</small>
                                <ul class="small text-muted mb-0">
                                    {% for wrong in item.common_wrong %}
                                    <li>"{{ wrong.answer }}" ({{ wrong.count }} students)</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}

                    {% if insights.misconceptions %}
                    <h6 class="text-warning"><i class="bi bi-question-circle me-1"></i>Potential Misconceptions</h6>
                    <ul class="list-unstyled">
                        {% for item in insights.misconceptions %}
                        <li class="mb-2">
                            <div class="d-flex align-items-start">
                                <span class="badge bg-warning text-dark me-2">Q{{ item.question }}</span>
                                <div>
                                    <small class="text-muted">{{ item.affected_count }} students affected</small>
                                    <p class="small mb-0 fst-italic">"{{ item.sample_feedback }}"</p>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}

                    {% if not insights.strengths and not insights.improvements %}
                    <p class="text-muted mb-0">Insights will appear after more submissions are graded.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Right Column: Student List -->
        <div class="col-lg-7 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-people me-2"></i>Student Submissions</h5>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary active" onclick="filterStudents('all')">All</button>
                        <button class="btn btn-outline-success" onclick="filterStudents('reviewed')">Reviewed</button>
                        <button class="btn btn-outline-warning" onclick="filterStudents('pending')">Pending Review</button>
                        <button class="btn btn-outline-info" onclick="filterStudents('ai_feedback_sent')">AI Feedback Sent</button>
                        <button class="btn btn-outline-danger" onclick="filterStudents('not_submitted')">Not Submitted</button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-hover mb-0" id="students-table">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Student</th>
                                    <th>Class</th>
                                    <th>Status</th>
                                    <th>{% if assignment.marking_type == 'rubric' or assignment.get('award_marks', True) %}Score{% else %}Result{% endif %}</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in student_submissions %}
                                <tr data-status="{{ item.display_status }}">
                                    <td>
                                        <strong>{{ item.student.name }}</strong>
                                        <br><small class="text-muted">{{ item.student.student_id }}</small>
                                    </td>
                                    <td>{{ item.student.class }}</td>
                                    <td>
                                        {% if item.status == 'reviewed' or item.status == 'approved' %}
                                        <span class="badge bg-success">Reviewed</span>
                                        {% elif item.display_status == 'ai_feedback_sent' %}
                                        <span class="badge bg-info"><i class="bi bi-robot me-1"></i>AI Feedback Sent</span>
                                        {% elif item.display_status == 'pending' %}
                                        <span class="badge bg-warning text-dark"><i class="bi bi-clock me-1"></i>Pending Review</span>
                                        {% elif item.status == 'submitted' %}
                                        <span class="badge bg-warning text-dark">Pending</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Not Submitted</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.submission and item.display_marks is not none %}
                                        {% if assignment.marking_type == 'rubric' or assignment.get('award_marks', True) %}
                                        <span class="{% if item.percentage >= 70 %}text-success{% elif item.percentage >= 50 %}text-warning{% else %}text-danger{% endif %} fw-bold">
                                            {{ "%.0f"|format(item.display_marks) }}/{{ assignment.total_marks }}
                                        </span>
                                        <br><small class="text-muted">{{ "%.0f"|format(item.percentage) }}%</small>
                                        {% else %}
                                        {% if item.percentage >= 99.9 %}
                                        <span class="badge bg-success">Correct</span>
                                        {% elif item.percentage <= 0.01 %}
                                        <span class="badge bg-danger">Incorrect</span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark">Partial correct</span>
                                        {% endif %}
                                        {% endif %}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if item.submission %}
                                        <a href="{{ url_for('review_submission', submission_id=item.submission.submission_id) }}"
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.sticky-top {
    background: white;
    z-index: 10;
}
</style>
{% endblock %}

{% block scripts %}
<script>
function filterStudents(status) {
    const rows = document.querySelectorAll('#students-table tbody tr');
    const buttons = document.querySelectorAll('.btn-group .btn');

    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');

    rows.forEach(row => {
        const rowStatus = row.dataset.status;

        if (status === 'all') {
            row.style.display = '';
        } else if (status === 'reviewed') {
            row.style.display = (rowStatus === 'reviewed' || rowStatus === 'approved') ? '' : 'none';
        } else if (status === 'pending') {
            row.style.display = rowStatus === 'pending' ? '' : 'none';
        } else if (status === 'ai_feedback_sent') {
            row.style.display = rowStatus === 'ai_feedback_sent' ? '' : 'none';
        } else if (status === 'not_submitted') {
            row.style.display = rowStatus === 'not_submitted' ? '' : 'none';
        }
    });
}

function generateClassSummary() {
    const content = document.getElementById('ai-summary-content');
    const loading = document.getElementById('summary-loading');
    const placeholder = document.getElementById('summary-placeholder');
    const genBtn = document.getElementById('generate-btn');
    const regenBtn = document.getElementById('regenerate-btn');

    // Hide existing content, show spinner
    content.querySelectorAll('.row, hr, h6, .text-center:not(#summary-loading)').forEach(el => el.classList.add('d-none'));
    if (placeholder) placeholder.classList.add('d-none');
    loading.classList.remove('d-none');
    if (genBtn) genBtn.disabled = true;
    if (regenBtn) regenBtn.disabled = true;

    fetch('{{ url_for("generate_class_summary_api", assignment_id=assignment.assignment_id) }}', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(r => r.json())
    .then(data => {
        loading.classList.add('d-none');
        if (data.success) {
            renderSummary(data.summary);
        } else {
            content.innerHTML = `<div class="text-center text-danger py-3">
                <i class="bi bi-exclamation-circle" style="font-size:1.5rem;"></i>
                <p class="mt-2 mb-0">${data.error || 'Failed to generate summary'}</p>
            </div>`;
        }
        // Update button to "Regenerate"
        const header = document.querySelector('#ai-summary-card .card-header div:last-child');
        header.innerHTML = `<small class="text-muted me-2" id="summary-timestamp">Generated: just now</small>
            <button class="btn btn-sm btn-outline-primary" onclick="generateClassSummary()" id="regenerate-btn">
                <i class="bi bi-arrow-clockwise me-1"></i>Regenerate
            </button>`;
    })
    .catch(err => {
        loading.classList.add('d-none');
        content.innerHTML = `<div class="text-center text-danger py-3">
            <i class="bi bi-exclamation-circle" style="font-size:1.5rem;"></i>
            <p class="mt-2 mb-0">Network error. Please try again.</p>
        </div>`;
    });
}

function renderSummary(s) {
    const content = document.getElementById('ai-summary-content');
    let html = '<div class="row g-3">';

    if (s.concepts_grasped && s.concepts_grasped.length) {
        html += '<div class="col-md-6"><h6 class="text-success"><i class="bi bi-check-circle-fill me-1"></i>Concepts Grasped</h6><ul class="list-unstyled">';
        s.concepts_grasped.forEach(c => html += `<li class="mb-1"><i class="bi bi-check text-success me-1"></i>${escapeHtml(c)}</li>`);
        html += '</ul></div>';
    }
    if (s.misconceptions && s.misconceptions.length) {
        html += '<div class="col-md-6"><h6 class="text-warning"><i class="bi bi-exclamation-triangle-fill me-1"></i>Misconceptions</h6><ul class="list-unstyled">';
        s.misconceptions.forEach(m => html += `<li class="mb-1"><i class="bi bi-exclamation-circle text-warning me-1"></i>${escapeHtml(m)}</li>`);
        html += '</ul></div>';
    }
    if (s.areas_needing_clarification && s.areas_needing_clarification.length) {
        html += '<div class="col-md-6"><h6 class="text-danger"><i class="bi bi-flag-fill me-1"></i>Areas Needing Clarification</h6><ul class="list-unstyled">';
        s.areas_needing_clarification.forEach(a => html += `<li class="mb-1"><i class="bi bi-arrow-right text-danger me-1"></i>${escapeHtml(a)}</li>`);
        html += '</ul></div>';
    }
    if (s.recommended_actions && s.recommended_actions.length) {
        html += '<div class="col-md-6"><h6 class="text-primary"><i class="bi bi-list-check me-1"></i>Recommended Actions</h6><ol class="ps-3">';
        s.recommended_actions.forEach(r => html += `<li class="mb-1">${escapeHtml(r)}</li>`);
        html += '</ol></div>';
    }
    html += '</div>';

    if (s.question_notes && s.question_notes.length) {
        html += '<hr><h6><i class="bi bi-card-text me-1"></i>Per-Question Notes</h6><div class="row g-2">';
        s.question_notes.forEach(qn => {
            html += `<div class="col-md-6"><div class="d-flex align-items-start">
                <span class="badge bg-secondary me-2">Q${qn.q_num}</span>
                <small>${escapeHtml(qn.note)}</small>
            </div></div>`;
        });
        html += '</div>';
    }

    content.innerHTML = html;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
