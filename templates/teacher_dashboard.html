{% extends "base.html" %}

{% block title %}Teacher Dashboard - School Portal{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark teacher-nav">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('teacher_dashboard') }}">
            <i class="bi bi-mortarboard-fill me-2"></i>Teacher Portal
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('teacher_dashboard') }}">
                        <i class="bi bi-speedometer2 me-1"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_assignments') }}">
                        <i class="bi bi-journal-text me-1"></i>Assignments
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_submissions') }}">
                        <i class="bi bi-inbox me-1"></i>Submissions
                        {% if stats.pending_submissions > 0 %}
                        <span class="badge bg-danger">{{ stats.pending_submissions }}</span>
                        {% endif %}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_messages') }}">
                        <i class="bi bi-chat-dots me-1"></i>Messages
                        {% if stats.unread_messages > 0 %}
                        <span class="badge bg-danger">{{ stats.unread_messages }}</span>
                        {% endif %}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_settings') }}">
                        <i class="bi bi-gear me-1"></i>Settings
                    </a>
                </li>
            </ul>
            <div class="navbar-nav">
                <span class="navbar-text me-3">
                    <i class="bi bi-person-workspace me-1"></i>{{ session.teacher_name }}
                </span>
                <a class="nav-link" href="{{ url_for('teacher_logout') }}">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </a>
            </div>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Welcome -->
    <div class="welcome-section mb-4">
        <h1>Welcome, {{ teacher.name }}! ðŸ‘‹</h1>
        <p class="text-muted">
            {% if teacher.telegram_id %}
            <span class="text-success"><i class="bi bi-telegram me-1"></i>Telegram Connected</span>
            {% else %}
            <span class="text-warning"><i class="bi bi-exclamation-circle me-1"></i>Telegram not linked - <a href="{{ url_for('teacher_settings') }}">Setup now</a></span>
            {% endif %}
        </p>
    </div>
    
    <!-- Stats Cards -->
    <div class="row g-4 mb-5">
        <div class="col-md-3">
            <div class="stat-card stat-primary">
                <div class="stat-icon">
                    <i class="bi bi-journal-text"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ stats.total_assignments }}</h3>
                    <p>Assignments</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card stat-warning">
                <div class="stat-icon">
                    <i class="bi bi-hourglass-split"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ stats.pending_submissions }}</h3>
                    <p>Pending Review</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card stat-success">
                <div class="stat-icon">
                    <i class="bi bi-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ stats.approved_submissions }}</h3>
                    <p>Approved</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card stat-info">
                <div class="stat-icon">
                    <i class="bi bi-chat-dots"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ stats.unread_messages }}</h3>
                    <p>Unread Messages</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <a href="{{ url_for('create_assignment') }}" class="action-card">
                <div class="action-icon">
                    <i class="bi bi-plus-circle"></i>
                </div>
                <div class="action-info">
                    <h5>Create Assignment</h5>
                    <p>Create a new assignment for your students</p>
                </div>
            </a>
        </div>
        <div class="col-md-4">
            <a href="{{ url_for('teacher_assignments') }}" class="action-card">
                <div class="action-icon" style="background: rgba(99, 102, 241, 0.1); color: #6366f1;">
                    <i class="bi bi-journal-text"></i>
                </div>
                <div class="action-info">
                    <h5>My Assignments</h5>
                    <p>{{ stats.assignments }} assignment(s) created</p>
                </div>
            </a>
        </div>
        <div class="col-md-4">
            <a href="{{ url_for('teacher_submissions', status='pending') }}" class="action-card">
                <div class="action-icon">
                    <i class="bi bi-inbox"></i>
                </div>
                <div class="action-info">
                    <h5>Review Submissions</h5>
                    <p>{{ stats.pending_submissions }} submissions awaiting review</p>
                </div>
            </a>
        </div>
    </div>
    
    <!-- My Classes & Teaching Groups -->
    {% if classes or teaching_groups %}
    <div class="section-header mb-3">
        <h2><i class="bi bi-people me-2"></i>My Classes & Students</h2>
        <div class="d-flex align-items-center gap-2">
            <label class="small text-muted me-1">View assignment:</label>
            <select class="form-select form-select-sm" id="assignment-filter" style="width: auto;">
                <option value="">Select assignment...</option>
                {% for a in assignments %}
                <option value="{{ a.assignment_id }}">{{ a.title }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    
    <div class="row g-4 mb-5">
        {% for cls in classes %}
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-collection me-2 text-primary"></i>{{ cls.class_id }}
                        {% if cls.name and cls.name != cls.class_id %}<small class="text-muted">({{ cls.name }})</small>{% endif %}
                    </h5>
                    <span class="badge bg-primary">{{ cls.student_count }} students</span>
                </div>
                <div class="card-body p-0">
                    {% if cls.students %}
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Student</th>
                                    <th class="text-end">Status</th>
                                </tr>
                            </thead>
                            <tbody class="student-list" data-class="{{ cls.class_id }}">
                                {% for student in cls.students %}
                                <tr data-student-id="{{ student.student_id }}">
                                    <td>
                                        <strong>{{ student.name }}</strong>
                                        <br><small class="text-muted">{{ student.student_id }}</small>
                                    </td>
                                    <td class="text-end student-status">
                                        <span class="badge bg-light text-muted">-</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted p-3 mb-0">No students in this class</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
        
        {% for group in teaching_groups %}
        <div class="col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-diagram-3 me-2 text-info"></i>{{ group.name }}
                        <small class="text-muted">({{ group.class_id }})</small>
                    </h5>
                    <span class="badge bg-info">{{ group.student_count }} students</span>
                </div>
                <div class="card-body p-0">
                    {% if group.students %}
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Student</th>
                                    <th class="text-end">Status</th>
                                </tr>
                            </thead>
                            <tbody class="student-list" data-group="{{ group.group_id }}">
                                {% for student in group.students %}
                                <tr data-student-id="{{ student.student_id }}">
                                    <td>
                                        <strong>{{ student.name }}</strong>
                                        <br><small class="text-muted">{{ student.student_id }}</small>
                                    </td>
                                    <td class="text-end student-status">
                                        <span class="badge bg-light text-muted">-</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-muted p-3 mb-0">No students in this group</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Recent Pending Submissions -->
    {% if recent_pending %}
    <div class="section-header">
        <h2><i class="bi bi-clock-history me-2"></i>Recent Pending Submissions</h2>
        <a href="{{ url_for('teacher_submissions', status='pending') }}" class="btn btn-outline-primary btn-sm">View All</a>
    </div>
    
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Student</th>
                    <th>Assignment</th>
                    <th>Submitted</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for sub in recent_pending %}
                <tr>
                    <td>
                        <strong>{{ sub.student.name if sub.student else 'Unknown' }}</strong>
                        <br><small class="text-muted">{{ sub.student.student_id if sub.student else '' }}</small>
                    </td>
                    <td>{{ sub.assignment.title if sub.assignment else 'Unknown' }}</td>
                    <td>{{ (sub.submitted_at|sgt).strftime('%d %b, %H:%M') if sub.submitted_at else 'N/A' }} SGT</td>
                    <td>
                        {% if sub.status == 'ai_reviewed' %}
                        <span class="badge bg-info"><i class="bi bi-robot me-1"></i>AI Reviewed</span>
                        {% else %}
                        <span class="badge bg-warning"><i class="bi bi-clock me-1"></i>Pending</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('review_submission', submission_id=sub.submission_id) }}" class="btn btn-sm btn-primary">
                            <i class="bi bi-eye me-1"></i>Review
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <h4>All Caught Up!</h4>
        <p>No pending submissions to review.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // Assignment filter - load student statuses when assignment selected
    document.getElementById('assignment-filter').addEventListener('change', async function() {
        const assignmentId = this.value;
        
        // Reset all statuses if no assignment selected
        if (!assignmentId) {
            document.querySelectorAll('.student-status').forEach(cell => {
                cell.innerHTML = '<span class="badge bg-light text-muted">-</span>';
            });
            return;
        }
        
        // Collect all student IDs
        const studentIds = [];
        document.querySelectorAll('[data-student-id]').forEach(row => {
            studentIds.push(row.dataset.studentId);
        });
        
        if (studentIds.length === 0) return;
        
        // Show loading state
        document.querySelectorAll('.student-status').forEach(cell => {
            cell.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
        });
        
        try {
            // Build query string
            const params = new URLSearchParams();
            params.append('assignment_id', assignmentId);
            studentIds.forEach(id => params.append('student_ids[]', id));
            
            const response = await fetch(`/teacher/api/student-statuses?${params.toString()}`);
            const data = await response.json();
            
            if (data.success && data.statuses) {
                // Update each student's status
                document.querySelectorAll('[data-student-id]').forEach(row => {
                    const studentId = row.dataset.studentId;
                    const statusCell = row.querySelector('.student-status');
                    const status = data.statuses[studentId];
                    
                    if (status) {
                        let icon = '';
                        if (status.status === 'ai_reviewed') icon = '<i class="bi bi-robot me-1"></i>';
                        else if (status.status === 'pending') icon = '<i class="bi bi-clock me-1"></i>';
                        else if (status.status === 'returned') icon = '<i class="bi bi-check-circle me-1"></i>';
                        else if (status.status === 'none') icon = '<i class="bi bi-dash me-1"></i>';
                        
                        statusCell.innerHTML = `<span class="badge bg-${status.class}">${icon}${status.label}</span>`;
                    }
                });
            }
        } catch (e) {
            console.error('Error loading statuses:', e);
            document.querySelectorAll('.student-status').forEach(cell => {
                cell.innerHTML = '<span class="badge bg-danger">Error</span>';
            });
        }
    });
</script>
{% endblock %}
