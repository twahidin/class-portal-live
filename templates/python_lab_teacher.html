{% extends "base.html" %}

{% block title %}Python Lab - Teacher Portal{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.min.js"></script>
<style>
.cell-card textarea { font-family: var(--bs-font-monospace); font-size: 0.9rem; }
.pylab-output { max-height: 300px; overflow: auto; white-space: pre-wrap; word-wrap: break-word; }
.pylab-input-field { background: transparent; border: none; border-bottom: 1px solid #6c9; color: #6c9; outline: none; font-family: var(--bs-font-monospace); font-size: 0.85rem; width: 60%; min-width: 120px; }
.pylab-input-field:focus { border-bottom-color: #fff; color: #fff; }
</style>
{% endblock %}

{% block navbar %}
{% set active_nav = 'learning_tools' %}
{% include 'partials/teacher_navbar.html' %}
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
        <div>
            <h1 class="mb-1"><i class="bi bi-code-slash me-2"></i>Python Lab</h1>
            <p class="text-muted mb-0">Write and run Python code. <code>input()</code> works interactively. Max {{ execute_timeout }}s per run. <span class="text-muted small">iPad-friendly: curly quotes are auto-converted to straight quotes.</span></p>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">Templates</button>
                <ul class="dropdown-menu" id="templates-menu"></ul>
            </div>
            <button type="button" class="btn btn-outline-primary" id="add-code-cell"><i class="bi bi-plus-lg me-1"></i>Add code cell</button>
        </div>
    </div>

    <div id="cells-container" class="mb-4"></div>

    <div class="card border-0 bg-light">
        <div class="card-body">
            <h6 class="card-title text-muted"><i class="bi bi-info-circle me-1"></i>Quick reference</h6>
            <div class="row g-2 small">
                <div class="col-md-4"><code>int, float, bool, str, list, dict</code> — data types</div>
                <div class="col-md-4"><code>.upper() .lower() .find() .split()</code> — strings</div>
                <div class="col-md-4"><code>len() min() max() sum()</code> — built-ins</div>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    var executeTimeout = {{ execute_timeout }};
    var socket = io({ transports: ['websocket', 'polling'] });
    var templates = [
        { name: 'Hello World', code: '# Hello World\nprint("Hello, Python Lab!")' },
        { name: 'Variables', code: '# Variables\nname = "Student"\nage = 16\nscore = 85.5\nprint(f"Name: {name}, Age: {age}, Score: {score}")' },
        { name: 'List operations', code: '# List operations\nnumbers = [5, 2, 8, 1, 9, 3]\nminimum = numbers[0]\nmaximum = numbers[0]\nfor num in numbers:\n    if num < minimum: minimum = num\n    if num > maximum: maximum = num\nprint(f"List: {numbers}")\nprint(f"Min: {minimum}, Max: {maximum}")' },
        { name: 'String manipulation', code: '# String manipulation\ntext = "Hello, Computing!"\nprint(f"Length: {len(text)}")\nprint(f"Upper: {text.upper()}")\nprint(f"Lower: {text.lower()}")\nprint(f"First 5: {text[:5]}")' },
        { name: 'User-defined function', code: '# User-defined function\ndef average(nums):\n    total = 0\n    for n in nums:\n        total += n\n    return total / len(nums)\nscores = [75, 82, 90, 68, 95]\nprint(f"Average: {average(scores):.2f}")' },
        { name: 'User input', code: 'name = input("What is your name? ")\nage = input("How old are you? ")\nprint(f"Hello {name}, you are {age} years old!")' },
    ];

    var container = document.getElementById('cells-container');
    var cellId = 0;
    var cells = [{ id: String(++cellId), type: 'code', content: '# Write your Python code here\nprint("Hello!")', output: '', running: false }];
    var runningCellId = null;

    function escapeHtml(s) {
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
    }

    function renderCells() {
        container.innerHTML = cells.map(function(c) {
            var isRunning = c.running;
            var runBtn = isRunning
                ? '<button type="button" class="btn btn-sm btn-danger stop-cell" title="Stop"><i class="bi bi-stop-fill"></i></button> '
                : '<button type="button" class="btn btn-sm btn-outline-success run-cell" title="Run"><i class="bi bi-play-fill"></i></button> ';
            var out = '';
            if (isRunning) {
                out = '<div class="pylab-output-area mt-2" data-output-id="' + c.id + '"><pre class="mb-0 small bg-dark text-light rounded p-2 pylab-output"></pre></div>';
            } else if ((c.output || '').trim()) {
                out = '<pre class="mb-0 small bg-dark text-light rounded p-2 mt-2 pylab-output">' + escapeHtml(c.output) + '</pre>';
            }
            return '<div class="card mb-3 cell-card" data-id="' + c.id + '">' +
                '<div class="card-header py-2 d-flex justify-content-between align-items-center">' +
                '<span class="badge bg-success">code</span>' +
                '<div>' + runBtn +
                '<button type="button" class="btn btn-sm btn-outline-danger delete-cell" title="Delete">' +
                '<i class="bi bi-trash"></i></button>' +
                '</div></div>' +
                '<div class="card-body p-2">' +
                '<textarea class="form-control font-monospace small" rows="6" data-id="' + c.id + '" placeholder="# Python code...">' + escapeHtml(c.content) + '</textarea>' +
                out +
                '</div></div>';
        }).join('');

        container.querySelectorAll('.run-cell').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var id = this.closest('.cell-card').getAttribute('data-id');
                runCell(id);
            });
        });
        container.querySelectorAll('.stop-cell').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var id = this.closest('.cell-card').getAttribute('data-id');
                stopCell(id);
            });
        });
        container.querySelectorAll('.delete-cell').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var id = this.closest('.cell-card').getAttribute('data-id');
                if (cells.length <= 1) return;
                cells = cells.filter(function(c) { return c.id !== id; });
                renderCells();
            });
        });
        container.querySelectorAll('textarea[data-id]').forEach(function(ta) {
            ta.addEventListener('input', function() {
                var id = this.getAttribute('data-id');
                var c = cells.find(function(x) { return x.id === id; });
                if (c) c.content = this.value;
            });
        });
    }

    function getOutputPre(cellId) {
        var area = container.querySelector('[data-output-id="' + cellId + '"]');
        return area ? area.querySelector('pre') : null;
    }

    function autoScroll(pre) {
        if (pre) pre.scrollTop = pre.scrollHeight;
    }

    function runCell(id) {
        var c = cells.find(function(x) { return x.id === id; });
        if (!c || runningCellId) return;
        c.running = true;
        c.output = '';
        runningCellId = id;
        renderCells();
        socket.emit('python_run', { cell_id: id, code: c.content });
    }

    function stopCell(id) {
        socket.emit('python_stop', { cell_id: id });
    }

    function finishCell(cellId) {
        var c = cells.find(function(x) { return x.id === cellId; });
        if (!c) return;
        var pre = getOutputPre(cellId);
        if (pre) c.output = pre.textContent;
        c.running = false;
        runningCellId = null;
        renderCells();
    }

    // --- Socket.IO listeners ---

    socket.on('python_output', function(data) {
        var pre = getOutputPre(data.cell_id);
        if (!pre) return;
        pre.textContent += data.text;
        autoScroll(pre);
    });

    socket.on('python_input_request', function(data) {
        var pre = getOutputPre(data.cell_id);
        if (!pre) return;
        pre.textContent += data.prompt;
        var area = pre.parentElement;
        var inputRow = document.createElement('div');
        inputRow.className = 'd-flex align-items-center bg-dark rounded px-2 py-1';
        inputRow.innerHTML = '<span class="text-light me-1" style="font-size:0.85rem;font-family:var(--bs-font-monospace);">&gt;</span>';
        var input = document.createElement('input');
        input.type = 'text';
        input.className = 'pylab-input-field';
        input.setAttribute('autocomplete', 'off');
        input.setAttribute('autocorrect', 'off');
        input.setAttribute('autocapitalize', 'off');
        input.setAttribute('spellcheck', 'false');
        inputRow.appendChild(input);
        area.appendChild(inputRow);
        input.focus();

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                var val = input.value;
                pre.textContent += val + '\n';
                inputRow.remove();
                autoScroll(pre);
                socket.emit('python_input', { cell_id: data.cell_id, value: val });
            }
        });
    });

    socket.on('python_done', function(data) {
        finishCell(data.cell_id);
        var c = cells.find(function(x) { return x.id === data.cell_id; });
        if (c && !(c.output || '').trim()) {
            c.output = '(no output)';
            renderCells();
        }
    });

    socket.on('python_error', function(data) {
        var c = cells.find(function(x) { return x.id === data.cell_id; });
        if (c) {
            c.output = 'Error: ' + (data.error || 'Unknown error');
            c.running = false;
        }
        runningCellId = null;
        renderCells();
    });

    // --- Cell management ---

    document.getElementById('add-code-cell').addEventListener('click', function() {
        cells.push({ id: String(++cellId), type: 'code', content: '# New cell\n', output: '', running: false });
        renderCells();
    });

    document.querySelector('#templates-menu').innerHTML = templates.map(function(t, i) {
        return '<li><button class="dropdown-item template-btn" type="button" data-index="' + i + '">' + escapeHtml(t.name) + '</button></li>';
    }).join('');
    document.querySelector('#templates-menu').addEventListener('click', function(e) {
        var btn = e.target.closest('.template-btn');
        if (!btn) return;
        var t = templates[parseInt(btn.getAttribute('data-index'), 10)];
        if (t) {
            cells.push({ id: String(++cellId), type: 'code', content: t.code, output: '', running: false });
            renderCells();
        }
    });

    renderCells();
})();
</script>
{% endblock %}
