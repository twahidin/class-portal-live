{% extends "base.html" %}

{% block title %}Settings - Teacher Portal{% endblock %}

{% block navbar %}
<nav class="navbar navbar-expand-lg navbar-dark teacher-nav">
    <div class="container">
        <a class="navbar-brand" href="{{ url_for('teacher_dashboard') }}">
            <i class="bi bi-mortarboard-fill me-2"></i>Teacher Portal
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto">
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_dashboard') }}">
                        <i class="bi bi-speedometer2 me-1"></i>Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_assignments') }}">
                        <i class="bi bi-journal-text me-1"></i>Assignments
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_submissions') }}">
                        <i class="bi bi-inbox me-1"></i>Submissions
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ url_for('teacher_messages') }}">
                        <i class="bi bi-chat-dots me-1"></i>Messages
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{{ url_for('teacher_settings') }}">
                        <i class="bi bi-gear me-1"></i>Settings
                    </a>
                </li>
            </ul>
            <div class="navbar-nav">
                <a class="nav-link" href="{{ url_for('teacher_logout') }}">
                    <i class="bi bi-box-arrow-right me-1"></i>Logout
                </a>
            </div>
        </div>
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="page-header mb-4">
        <h1><i class="bi bi-gear me-2"></i>Settings</h1>
        <p class="text-muted">Manage your account and integrations</p>
    </div>
    
    {% if success %}
    <div class="alert alert-success alert-dismissible fade show">
        <i class="bi bi-check-circle me-2"></i>{{ success }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-exclamation-circle me-2"></i>{{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    <div class="row">
        <div class="col-lg-8">
            <form method="POST">
                <!-- Account Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-person me-2"></i>Account Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Teacher ID</label>
                                <input type="text" class="form-control" value="{{ teacher.teacher_id }}" disabled>
                                <small class="text-muted">Cannot be changed</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" name="name" value="{{ teacher.name }}" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Subjects (comma-separated)</label>
                            <input type="text" class="form-control" name="subjects" 
                                   value="{{ teacher.subjects | join(', ') if teacher.subjects else '' }}"
                                   placeholder="e.g., Mathematics, Physics">
                        </div>
                    </div>
                </div>
                
                <!-- Change Password -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-key me-2"></i>Change Password</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Current Password</label>
                                    <input type="password" class="form-control" id="current_password" placeholder="Enter current password">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">New Password</label>
                                    <input type="password" class="form-control" id="new_password" placeholder="Enter new password">
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-warning" id="change-password-btn">
                            <i class="bi bi-key me-1"></i>Change Password
                        </button>
                        <div id="password-result" class="mt-2"></div>
                    </div>
                </div>
                
                <!-- Telegram Integration -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-telegram me-2"></i>Telegram Integration</h5>
                    </div>
                    <div class="card-body">
                        {% if teacher.telegram_id %}
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            <strong>Connected!</strong> Telegram ID: {{ teacher.telegram_id }}
                        </div>
                        <p class="text-muted">You will receive student messages and notifications via Telegram.</p>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Not Connected</strong>
                        </div>
                        <div class="telegram-setup">
                            <h6>How to connect Telegram:</h6>
                            <ol>
                                <li>Open Telegram and search for the school bot</li>
                                <li>Start a conversation with the bot</li>
                                <li>Send the command: <code>/verify {{ teacher.teacher_id }}</code></li>
                                <li>Refresh this page to confirm connection</li>
                            </ol>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- AI Marking -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-robot me-2"></i>AI Marking (Anthropic)</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Configure your own Anthropic API key for AI-powered assignment feedback.
                            If not set, the system will use the default API key (if available).
                        </p>
                        
                        <div class="mb-3">
                            <label class="form-label">Anthropic API Key</label>
                            <input type="password" class="form-control" name="anthropic_api_key" 
                                   placeholder="sk-ant-api...">
                            {% if teacher.anthropic_api_key %}
                            <small class="text-success"><i class="bi bi-check-circle me-1"></i>API key configured</small>
                            {% else %}
                            <small class="text-muted">Leave blank to use system default</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Google Drive -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="bi bi-google me-2"></i>Google Drive Integration</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Configure a Google Drive folder to automatically save student submission PDFs.
                        </p>
                        
                        <div class="mb-3">
                            <label class="form-label">Google Drive Folder ID</label>
                            <input type="text" class="form-control" name="google_drive_folder_id" 
                                   value="{{ teacher.google_drive_folder_id or '' }}"
                                   placeholder="e.g., 1aBcDeFgHiJkLmNoPqRsTuVwXyZ">
                            <small class="text-muted">
                                Find this in the URL when viewing the folder: drive.google.com/drive/folders/<strong>[FOLDER_ID]</strong>
                            </small>
                        </div>
                        
                        {% if teacher.google_drive_folder_id %}
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-1"></i>Folder configured
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-save me-2"></i>Save Settings
                    </button>
                </div>
            </form>
            
            <!-- Manage My Classes (outside main form) -->
            <div class="card mb-4 mt-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-collection me-2"></i>My Classes</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Select which classes you teach. Students in these classes will be assigned to you.</p>
                    
                    <div class="mb-3">
                        <label class="form-label">Assign Class to Yourself</label>
                        <div class="input-group">
                            <select class="form-select" id="assign-class-select">
                                <option value="">Select a class...</option>
                                {% for c in classes %}
                                <option value="{{ c.class_id }}">{{ c.class_id }}{% if c.name and c.name != c.class_id %} ({{ c.name }}){% endif %}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-primary" id="assign-class-btn">
                                <i class="bi bi-plus-lg"></i> Assign
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Currently Assigned Classes</label>
                        <div id="my-classes-list">
                            {% if teacher.classes %}
                            {% for cls in teacher.classes %}
                            <span class="badge bg-info me-1 mb-1 d-inline-flex align-items-center" style="font-size: 0.9rem;">
                                {{ cls }}
                                <button type="button" class="btn-close btn-close-white ms-2 remove-class-btn" 
                                        data-class-id="{{ cls }}" style="font-size: 0.6rem;"></button>
                            </span>
                            {% endfor %}
                            {% else %}
                            <span class="text-muted">No classes assigned</span>
                            {% endif %}
                        </div>
                    </div>
                    <div id="class-result"></div>
                </div>
            </div>
            
            <!-- Assign Students to My Classes -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-person-plus me-2"></i>Assign Students to My Classes</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Select existing students and assign them to one of your classes. Students can belong to multiple classes.</p>
                    
                    <form id="assign-student-form">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Select Student *</label>
                                <select class="form-select" id="student_select" required>
                                    <option value="">Choose a student...</option>
                                    {% for s in all_students %}
                                    <option value="{{ s.student_id }}">{{ s.name }} ({{ s.student_id }}){% if s.classes %} - {{ s.classes | join(', ') }}{% elif s.class %} - {{ s.class }}{% endif %}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Assign to Class *</label>
                                <select class="form-select" id="target_class" required>
                                    <option value="">Choose one of your classes...</option>
                                    {% for cls in teacher.classes or [] %}
                                    <option value="{{ cls }}">{{ cls }}</option>
                                    {% endfor %}
                                </select>
                                {% if not teacher.classes %}
                                <small class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>You need to assign yourself to a class first (above)</small>
                                {% endif %}
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success" {% if not teacher.classes %}disabled{% endif %}>
                            <i class="bi bi-person-plus me-1"></i>Assign Student
                        </button>
                    </form>
                    <div id="assign-student-result" class="mt-2"></div>
                    
                    <!-- My Students List -->
                    <hr class="my-4">
                    <h6><i class="bi bi-people me-2"></i>My Students</h6>
                    <div class="table-responsive" style="max-height: 300px;">
                        <table class="table table-sm table-hover">
                            <thead class="sticky-top bg-white">
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Classes</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="my-students-tbody">
                                {% for s in my_students %}
                                <tr>
                                    <td><code>{{ s.student_id }}</code></td>
                                    <td>{{ s.name }}</td>
                                    <td>
                                        {% if s.classes %}
                                        {{ s.classes | join(', ') }}
                                        {% elif s.class %}
                                        {{ s.class }}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-danger btn-sm remove-student-btn" 
                                                data-student-id="{{ s.student_id }}" title="Remove from my students">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="text-center text-muted">No students assigned to you yet</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle me-2"></i>Help</h5>
                </div>
                <div class="card-body">
                    <h6>Telegram Bot</h6>
                    <p class="small text-muted">
                        Connect Telegram to receive instant notifications when students submit assignments or send messages.
                    </p>
                    
                    <h6>AI Marking</h6>
                    <p class="small text-muted">
                        AI-powered feedback helps students understand their mistakes. You can use your own Anthropic API key for unlimited usage.
                    </p>
                    
                    <h6>Google Drive</h6>
                    <p class="small text-muted">
                        Automatically archive student submissions as PDFs in your Drive for record keeping.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Change Password
    document.getElementById('change-password-btn').addEventListener('click', async () => {
        const currentPassword = document.getElementById('current_password').value;
        const newPassword = document.getElementById('new_password').value;
        const resultDiv = document.getElementById('password-result');
        
        if (!currentPassword || !newPassword) {
            resultDiv.innerHTML = '<div class="alert alert-warning">Please enter both current and new password</div>';
            return;
        }
        
        if (newPassword.length < 4) {
            resultDiv.innerHTML = '<div class="alert alert-warning">New password must be at least 4 characters</div>';
            return;
        }
        
        try {
            const response = await fetch('/teacher/change_password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
            });
            
            const data = await response.json();
            
            if (data.success) {
                resultDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle me-1"></i>Password changed successfully!</div>';
                document.getElementById('current_password').value = '';
                document.getElementById('new_password').value = '';
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle me-1"></i>${data.error || 'Failed to change password'}</div>`;
            }
        } catch (e) {
            resultDiv.innerHTML = '<div class="alert alert-danger">Error changing password</div>';
        }
    });
    
    // Assign Class to Self
    document.getElementById('assign-class-btn').addEventListener('click', async () => {
        const classId = document.getElementById('assign-class-select').value;
        const resultDiv = document.getElementById('class-result');
        
        if (!classId) {
            resultDiv.innerHTML = '<div class="alert alert-warning">Please select a class</div>';
            return;
        }
        
        try {
            const response = await fetch('/teacher/assign_class', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ class_id: classId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                location.reload();
            } else {
                resultDiv.innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to assign class'}</div>`;
            }
        } catch (e) {
            resultDiv.innerHTML = '<div class="alert alert-danger">Error assigning class</div>';
        }
    });
    
    // Remove Class from Self
    document.querySelectorAll('.remove-class-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const classId = btn.dataset.classId;
            
            try {
                const response = await fetch('/teacher/remove_class', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ class_id: classId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.error || 'Failed to remove class');
                }
            } catch (e) {
                alert('Error removing class');
            }
        });
    });
    
    // Assign Student to Class
    const assignForm = document.getElementById('assign-student-form');
    if (assignForm) {
        assignForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultDiv = document.getElementById('assign-student-result');
            
            const studentId = document.getElementById('student_select').value;
            const classId = document.getElementById('target_class').value;
            
            if (!studentId || !classId) {
                resultDiv.innerHTML = '<div class="alert alert-warning">Please select both a student and a class</div>';
                return;
            }
            
            try {
                const response = await fetch('/teacher/assign_student_to_class', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: studentId, class_id: classId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle me-1"></i>${result.message}</div>`;
                    // Reload page to update student list
                    setTimeout(() => location.reload(), 1500);
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle me-1"></i>${result.error || 'Failed to assign student'}</div>`;
                }
            } catch (e) {
                resultDiv.innerHTML = '<div class="alert alert-danger">Error assigning student</div>';
            }
        });
    }
    
    // Remove Student from My Students
    document.querySelectorAll('.remove-student-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
            const studentId = btn.dataset.studentId;
            if (!confirm(`Remove student ${studentId} from your students?`)) return;
            
            try {
                const response = await fetch('/teacher/remove_student', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_id: studentId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    location.reload();
                } else {
                    alert(result.error || 'Failed to remove student');
                }
            } catch (e) {
                alert('Error removing student');
            }
        });
    });
</script>
{% endblock %}
