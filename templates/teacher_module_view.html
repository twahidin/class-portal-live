{% extends "base.html" %}

{% block title %}{{ module.title }} - Tree Editor{% endblock %}

{% block navbar %}
{% set active_nav = 'learning_tools' %}
{% include 'partials/teacher_navbar.html' %}
{% endblock %}

{% block content %}
<div class="tree-editor-layout">
    <!-- Toolbar -->
    <div class="tree-toolbar">
        <div class="d-flex align-items-center gap-2">
            <a href="{{ url_for('teacher_modules') }}" class="btn btn-outline-secondary btn-sm">
                <i class="bi bi-arrow-left"></i>
            </a>
            <div>
                <h5 class="mb-0">{{ module.title }}</h5>
                <small class="text-muted">{{ module.subject }}{% if module.year_level %} &middot; {{ module.year_level }}{% endif %}</small>
            </div>
        </div>
        <div class="d-flex align-items-center gap-2">
            <span class="badge bg-secondary" id="nodeCountBadge">0 nodes</span>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="collapseAllBtn" title="Collapse all">
                <i class="bi bi-arrows-collapse me-1"></i>Collapse
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="expandAllBtn" title="Expand all">
                <i class="bi bi-arrows-expand me-1"></i>Expand
            </button>
            <div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-secondary" id="zoomInBtn" title="Zoom in"><i class="bi bi-zoom-in"></i></button>
                <button type="button" class="btn btn-outline-secondary" id="zoomOutBtn" title="Zoom out"><i class="bi bi-zoom-out"></i></button>
                <button type="button" class="btn btn-outline-secondary" id="fitBtn" title="Fit to view"><i class="bi bi-arrows-fullscreen"></i></button>
            </div>
            {% if module.status != 'published' %}
            <button type="button" class="btn btn-primary btn-sm" id="publishBtn">
                <i class="bi bi-send me-1"></i>Publish
            </button>
            {% else %}
            <span class="badge bg-success align-self-center">Published</span>
            {% endif %}
            <button type="button" class="btn btn-outline-danger btn-sm" id="deleteTreeBtn" title="Delete entire tree">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>

    <!-- Main area: tree canvas + sidebar -->
    <div class="tree-main">
        <!-- Tree canvas -->
        <div class="tree-canvas-wrapper" id="treeCanvasWrapper">
            <div class="tree-viewport" id="treeViewport">
                <div class="tree-content" id="treeContent">
                    <!-- Tree rendered here -->
                </div>
            </div>
        </div>

        <!-- Right sidebar -->
        <div class="tree-sidebar" id="treeSidebar">
            <div class="sidebar-empty" id="sidebarEmpty">
                <i class="bi bi-hand-index-thumb display-6 text-muted"></i>
                <p class="text-muted mt-2 mb-0">Click a node to edit</p>
            </div>
            <div class="sidebar-editor" id="sidebarEditor" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Edit Node</h6>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="closeSidebar"><i class="bi bi-x-lg"></i></button>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Title</label>
                    <input type="text" class="form-control form-control-sm" id="editTitle">
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Subtitle</label>
                    <input type="text" class="form-control form-control-sm" id="editSubtitle" placeholder="e.g. Chapter 3">
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Description</label>
                    <textarea class="form-control form-control-sm" id="editDescription" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted">Color</label>
                    <div class="color-swatches" id="colorSwatches">
                        <button type="button" class="swatch" data-color="#667eea" style="background:#667eea;" title="Blue"></button>
                        <button type="button" class="swatch" data-color="#22c55e" style="background:#22c55e;" title="Green"></button>
                        <button type="button" class="swatch" data-color="#a855f7" style="background:#a855f7;" title="Purple"></button>
                        <button type="button" class="swatch" data-color="#f97316" style="background:#f97316;" title="Orange"></button>
                        <button type="button" class="swatch" data-color="#64748b" style="background:#64748b;" title="Slate"></button>
                        <button type="button" class="swatch" data-color="#ef4444" style="background:#ef4444;" title="Red"></button>
                        <button type="button" class="swatch" data-color="#06b6d4" style="background:#06b6d4;" title="Cyan"></button>
                        <button type="button" class="swatch" data-color="#eab308" style="background:#eab308;" title="Yellow"></button>
                    </div>
                </div>
                <div class="save-indicator mb-3" id="saveIndicator" style="display:none;">
                    <i class="bi bi-check-circle text-success me-1"></i>
                    <small class="text-success">Saved</small>
                </div>
                <hr>
                <button type="button" class="btn btn-outline-danger btn-sm w-100" id="deleteNodeBtn" style="display:none;">
                    <i class="bi bi-trash me-1"></i>Delete Node
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete confirm modal -->
<div class="modal fade" id="deleteNodeModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Delete Node</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">Delete <strong id="deleteNodeTitle"></strong> and all its children? This cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger btn-sm" id="confirmDeleteNodeBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<style>
.tree-editor-layout { display: flex; flex-direction: column; height: calc(100vh - 56px); overflow: hidden; }
.tree-toolbar { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 1rem; border-bottom: 1px solid #e2e8f0; background: #fff; flex-shrink: 0; }
.tree-main { display: flex; flex: 1; overflow: hidden; }
.tree-canvas-wrapper { flex: 1; overflow: hidden; position: relative; background: #f8fafc; }
.tree-viewport { width: 100%; height: 100%; overflow: auto; }
.tree-content { transform-origin: 0 0; padding: 40px 40px 80px; min-width: max-content; }
.tree-sidebar { width: 320px; border-left: 1px solid #e2e8f0; background: #fff; overflow-y: auto; padding: 1rem; flex-shrink: 0; display: flex; flex-direction: column; }
.sidebar-empty { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; }

/* CSS Tree */
.css-tree { list-style: none; padding: 0; margin: 0; }
.css-tree ul { list-style: none; padding-left: 28px; margin: 0; position: relative; }
.css-tree ul::before { content: ''; position: absolute; left: 14px; top: 0; bottom: 16px; width: 1px; background: #cbd5e1; }
.css-tree li { position: relative; padding: 4px 0; }
.css-tree ul > li::before { content: ''; position: absolute; left: -14px; top: 20px; width: 14px; height: 1px; background: #cbd5e1; }

.tree-node-card {
    display: inline-flex; align-items: center; gap: 8px;
    padding: 6px 12px; border-radius: 8px;
    border: 2px solid transparent; background: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    cursor: pointer; transition: all 0.15s; user-select: none;
    position: relative; min-width: 120px;
}
.tree-node-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.12); }
.tree-node-card.active { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.2); }
.tree-node-card .node-color-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
.tree-node-card .node-title { font-weight: 500; font-size: 0.875rem; }
.tree-node-card .node-subtitle { font-size: 0.75rem; color: #64748b; }
.tree-node-card .node-desc-icon { font-size: 0.7rem; color: #94a3b8; margin-left: auto; }
.tree-node-card .node-actions { display: none; position: absolute; right: -8px; top: 50%; transform: translateY(-50%); gap: 2px; }
.tree-node-card:hover .node-actions { display: flex; }
.node-action-btn {
    width: 22px; height: 22px; border-radius: 50%; border: 1px solid #e2e8f0;
    background: #fff; display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 0.65rem; color: #64748b; transition: all 0.15s;
}
.node-action-btn:hover { background: #f1f5f9; color: #334155; }
.node-action-btn.add-btn:hover { background: #dcfce7; color: #16a34a; border-color: #86efac; }
.node-action-btn.del-btn:hover { background: #fee2e2; color: #dc2626; border-color: #fca5a5; }

/* Collapse toggle */
.collapse-toggle {
    width: 20px; height: 20px; border-radius: 4px; border: 1px solid #cbd5e1;
    background: #fff; display: inline-flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 0.65rem; color: #64748b; transition: all 0.15s;
    margin-right: 4px; flex-shrink: 0; vertical-align: middle;
}
.collapse-toggle:hover { background: #f1f5f9; color: #334155; border-color: #94a3b8; }
.collapse-toggle .bi { transition: transform 0.2s; }
.collapse-toggle.collapsed .bi { transform: rotate(-90deg); }
.css-tree li > ul.collapsed-children { display: none; }
.child-count { font-size: 0.65rem; color: #94a3b8; margin-left: 2px; }

/* Color swatches */
.color-swatches { display: flex; gap: 6px; flex-wrap: wrap; }
.swatch { width: 28px; height: 28px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; transition: all 0.15s; }
.swatch:hover { transform: scale(1.15); }
.swatch.active { border-color: #1e293b; box-shadow: 0 0 0 2px #fff, 0 0 0 4px currentColor; }

/* Mobile responsive */
@media (max-width: 768px) {
    .tree-sidebar { position: fixed; right: 0; top: 0; bottom: 0; z-index: 1050; width: 300px; box-shadow: -4px 0 12px rgba(0,0,0,0.1); }
    .tree-sidebar.hidden { display: none; }
}
</style>

<script>
(function() {
    const moduleTree = {{ modules_json|safe }};
    const moduleId = '{{ module.module_id }}';
    const treeContent = document.getElementById('treeContent');
    const treeViewport = document.getElementById('treeViewport');
    const sidebarEmpty = document.getElementById('sidebarEmpty');
    const sidebarEditor = document.getElementById('sidebarEditor');
    const editTitle = document.getElementById('editTitle');
    const editSubtitle = document.getElementById('editSubtitle');
    const editDescription = document.getElementById('editDescription');
    const colorSwatches = document.getElementById('colorSwatches');
    const saveIndicator = document.getElementById('saveIndicator');
    const deleteNodeBtn = document.getElementById('deleteNodeBtn');
    const nodeCountBadge = document.getElementById('nodeCountBadge');

    let selectedNodeId = null;
    let saveTimeout = null;
    const collapsedNodes = new Set();

    // ---- Tree rendering ----
    function escapeHtml(s) {
        const d = document.createElement('div');
        d.textContent = s || '';
        return d.innerHTML;
    }

    function countNodes(node) {
        let c = 1;
        (node.children || []).forEach(ch => c += countNodes(ch));
        return c;
    }

    function countDescendants(node) {
        let c = 0;
        (node.children || []).forEach(ch => { c += 1 + countDescendants(ch); });
        return c;
    }

    function renderTree(node, isRoot) {
        const children = node.children || [];
        const hasDesc = !!(node.description || '').trim();
        const color = node.color || '#667eea';
        const subtitle = node.subtitle || '';
        const isCollapsed = collapsedNodes.has(node.module_id);

        let html = '<li>';
        html += '<div class="tree-node-card' + (selectedNodeId === node.module_id ? ' active' : '') + '" data-id="' + node.module_id + '">';

        // Collapse toggle for nodes with children
        if (children.length > 0) {
            html += '<button type="button" class="collapse-toggle' + (isCollapsed ? ' collapsed' : '') + '" data-toggle="' + node.module_id + '" title="' + (isCollapsed ? 'Expand' : 'Collapse') + '">';
            html += '<i class="bi bi-chevron-down"></i>';
            html += '</button>';
        }

        html += '<span class="node-color-dot" style="background:' + escapeHtml(color) + ';"></span>';
        html += '<div>';
        html += '<div class="node-title">' + escapeHtml(node.title) + '</div>';
        if (subtitle) html += '<div class="node-subtitle">' + escapeHtml(subtitle) + '</div>';
        html += '</div>';
        if (isCollapsed && children.length > 0) {
            html += '<span class="child-count" title="' + countDescendants(node) + ' hidden nodes">' + children.length + '</span>';
        }
        if (hasDesc) html += '<i class="bi bi-text-left node-desc-icon" title="Has description"></i>';
        html += '<div class="node-actions">';
        html += '<button type="button" class="node-action-btn add-btn" data-add="' + node.module_id + '" title="Add child"><i class="bi bi-plus"></i></button>';
        if (!isRoot) html += '<button type="button" class="node-action-btn del-btn" data-del="' + node.module_id + '" title="Delete"><i class="bi bi-trash3"></i></button>';
        html += '</div>';
        html += '</div>';

        if (children.length > 0) {
            html += '<ul' + (isCollapsed ? ' class="collapsed-children"' : '') + '>';
            children.forEach(ch => html += renderTree(ch, false));
            html += '</ul>';
        }
        html += '</li>';
        return html;
    }

    function redraw() {
        const count = countNodes(moduleTree);
        nodeCountBadge.textContent = count + ' node' + (count !== 1 ? 's' : '');
        treeContent.innerHTML = '<ul class="css-tree">' + renderTree(moduleTree, true) + '</ul>';
        bindNodeEvents();
    }

    function findNode(tree, id) {
        if (tree.module_id === id) return tree;
        for (const c of (tree.children || [])) {
            const found = findNode(c, id);
            if (found) return found;
        }
        return null;
    }

    function findParent(tree, id) {
        for (const c of (tree.children || [])) {
            if (c.module_id === id) return tree;
            const found = findParent(c, id);
            if (found) return found;
        }
        return null;
    }

    // ---- Node events ----
    function bindNodeEvents() {
        treeContent.querySelectorAll('.tree-node-card').forEach(card => {
            card.addEventListener('click', function(e) {
                if (e.target.closest('.node-action-btn') || e.target.closest('.collapse-toggle')) return;
                selectNode(this.dataset.id);
            });
        });
        treeContent.querySelectorAll('.add-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                addChild(this.dataset.add);
            });
        });
        treeContent.querySelectorAll('.del-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                promptDeleteNode(this.dataset.del);
            });
        });
        treeContent.querySelectorAll('.collapse-toggle').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const nodeId = this.dataset.toggle;
                if (collapsedNodes.has(nodeId)) {
                    collapsedNodes.delete(nodeId);
                } else {
                    collapsedNodes.add(nodeId);
                }
                redraw();
            });
        });
    }

    // ---- Select node ----
    function selectNode(id) {
        selectedNodeId = id;
        const node = findNode(moduleTree, id);
        if (!node) return;
        // Highlight
        treeContent.querySelectorAll('.tree-node-card').forEach(c => c.classList.remove('active'));
        const el = treeContent.querySelector('[data-id="' + id + '"]');
        if (el) el.classList.add('active');
        // Fill sidebar
        sidebarEmpty.style.display = 'none';
        sidebarEditor.style.display = 'block';
        editTitle.value = node.title || '';
        editSubtitle.value = node.subtitle || '';
        editDescription.value = node.description || '';
        // Color swatches
        colorSwatches.querySelectorAll('.swatch').forEach(s => {
            s.classList.toggle('active', s.dataset.color === (node.color || '#667eea'));
        });
        // Delete button: hide for root
        deleteNodeBtn.style.display = (id === moduleId) ? 'none' : 'block';
        saveIndicator.style.display = 'none';
    }

    // ---- Auto-save ----
    function scheduleSave() {
        if (saveTimeout) clearTimeout(saveTimeout);
        saveIndicator.style.display = 'none';
        saveTimeout = setTimeout(() => doSave(), 600);
    }

    async function doSave() {
        if (!selectedNodeId) return;
        const node = findNode(moduleTree, selectedNodeId);
        if (!node) return;
        const payload = {
            title: editTitle.value.trim() || 'Untitled',
            subtitle: editSubtitle.value.trim(),
            description: editDescription.value.trim(),
            color: node.color || '#667eea',
        };
        try {
            const res = await fetch('/teacher/modules/' + encodeURIComponent(moduleId) + '/node/' + encodeURIComponent(selectedNodeId), {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const data = await res.json();
            if (data.success) {
                node.title = payload.title;
                node.subtitle = payload.subtitle;
                node.description = payload.description;
                node.color = payload.color;
                redraw();
                selectNode(selectedNodeId);
                saveIndicator.style.display = 'block';
                setTimeout(() => { saveIndicator.style.display = 'none'; }, 2000);
            }
        } catch (e) { /* silent */ }
    }

    editTitle.addEventListener('input', scheduleSave);
    editSubtitle.addEventListener('input', scheduleSave);
    editDescription.addEventListener('input', scheduleSave);

    colorSwatches.querySelectorAll('.swatch').forEach(s => {
        s.addEventListener('click', function() {
            const node = findNode(moduleTree, selectedNodeId);
            if (!node) return;
            node.color = this.dataset.color;
            colorSwatches.querySelectorAll('.swatch').forEach(sw => sw.classList.remove('active'));
            this.classList.add('active');
            scheduleSave();
        });
    });

    // ---- Add child ----
    async function addChild(parentId) {
        try {
            const res = await fetch('/teacher/modules/' + encodeURIComponent(moduleId) + '/node', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ parent_node_id: parentId }),
            });
            const data = await res.json();
            if (data.success && data.node) {
                const parent = findNode(moduleTree, parentId);
                if (parent) {
                    if (!parent.children) parent.children = [];
                    parent.children.push(data.node);
                    if (!parent.children_ids) parent.children_ids = [];
                    parent.children_ids.push(data.node_id);
                }
                redraw();
                selectNode(data.node_id);
            } else {
                alert(data.error || 'Failed to add node');
            }
        } catch (e) { alert('Failed to add node'); }
    }

    // ---- Delete node ----
    let pendingDeleteId = null;
    const deleteModal = document.getElementById('deleteNodeModal');
    const deleteNodeTitle = document.getElementById('deleteNodeTitle');
    const confirmDeleteBtn = document.getElementById('confirmDeleteNodeBtn');

    function promptDeleteNode(id) {
        const node = findNode(moduleTree, id);
        if (!node) return;
        pendingDeleteId = id;
        deleteNodeTitle.textContent = node.title || 'this node';
        new bootstrap.Modal(deleteModal).show();
    }

    confirmDeleteBtn.addEventListener('click', async function() {
        if (!pendingDeleteId) return;
        confirmDeleteBtn.disabled = true;
        try {
            const res = await fetch('/teacher/modules/' + encodeURIComponent(moduleId) + '/node/' + encodeURIComponent(pendingDeleteId), {
                method: 'DELETE',
            });
            const data = await res.json();
            if (data.success) {
                // Remove from tree
                const parent = findParent(moduleTree, pendingDeleteId);
                if (parent) {
                    parent.children = (parent.children || []).filter(c => c.module_id !== pendingDeleteId);
                    parent.children_ids = (parent.children_ids || []).filter(id => id !== pendingDeleteId);
                }
                if (selectedNodeId === pendingDeleteId) {
                    selectedNodeId = null;
                    sidebarEditor.style.display = 'none';
                    sidebarEmpty.style.display = 'flex';
                }
                bootstrap.Modal.getInstance(deleteModal).hide();
                redraw();
            } else {
                alert(data.error || 'Delete failed');
            }
        } catch (e) { alert('Delete failed'); }
        confirmDeleteBtn.disabled = false;
    });

    deleteNodeBtn.addEventListener('click', function() {
        if (selectedNodeId && selectedNodeId !== moduleId) {
            promptDeleteNode(selectedNodeId);
        }
    });

    // ---- Close sidebar ----
    document.getElementById('closeSidebar').addEventListener('click', function() {
        selectedNodeId = null;
        sidebarEditor.style.display = 'none';
        sidebarEmpty.style.display = 'flex';
        treeContent.querySelectorAll('.tree-node-card').forEach(c => c.classList.remove('active'));
    });

    // ---- Zoom (buttons only, scroll wheel = native scroll) ----
    let scale = 1;
    function updateTransform() {
        treeContent.style.transform = 'scale(' + scale + ')';
    }
    document.getElementById('zoomInBtn').addEventListener('click', function() { scale = Math.min(scale * 1.2, 2.5); updateTransform(); });
    document.getElementById('zoomOutBtn').addEventListener('click', function() { scale = Math.max(scale / 1.2, 0.3); updateTransform(); });
    document.getElementById('fitBtn').addEventListener('click', function() { scale = 1; updateTransform(); treeViewport.scrollTop = 0; treeViewport.scrollLeft = 0; });

    // ---- Collapse / Expand all ----
    function collectNodeIds(node) {
        const ids = [];
        if ((node.children || []).length > 0) ids.push(node.module_id);
        (node.children || []).forEach(ch => ids.push(...collectNodeIds(ch)));
        return ids;
    }
    document.getElementById('collapseAllBtn').addEventListener('click', function() {
        collectNodeIds(moduleTree).forEach(id => collapsedNodes.add(id));
        redraw();
    });
    document.getElementById('expandAllBtn').addEventListener('click', function() {
        collapsedNodes.clear();
        redraw();
    });

    // ---- Publish ----
    const publishBtn = document.getElementById('publishBtn');
    if (publishBtn) {
        publishBtn.addEventListener('click', async function() {
            this.disabled = true;
            try {
                const res = await fetch('{{ url_for("publish_module", module_id=module.module_id) }}', { method: 'POST' });
                const data = await res.json();
                if (data.success) window.location.reload();
                else alert(data.error || 'Publish failed');
            } finally { this.disabled = false; }
        });
    }

    // ---- Delete tree ----
    document.getElementById('deleteTreeBtn').addEventListener('click', function() {
        if (!confirm('Delete this entire module tree? All nodes, resources, and student progress will be removed. This cannot be undone.')) return;
        this.disabled = true;
        fetch('{{ url_for("delete_module_tree", module_id=module.module_id) }}', { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                if (data.success) window.location.href = '{{ url_for("teacher_modules") }}';
                else { alert(data.error || 'Delete failed'); this.disabled = false; }
            })
            .catch(() => { alert('Delete failed'); this.disabled = false; });
    });

    // ---- Initial render ----
    redraw();
})();
</script>
{% endblock %}
